{% extends 'dashboard.html' %}
{% load  paginator i18n template_constancia %}
{% block  container %}

    <div class="app-content content">
        <div class="content-wrapper">
            <div class="content-header row">
                <div class="content-header-left col-md-6 col-12 mb-2">
                    <div class="row breadcrumbs-top">
                        <div class="breadcrumb-wrapper col-12">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item active">Constancias</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-body">
                <section id="patients-list">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="card-title">{{ title }}
                                        <strong class="text-primary">({{ page_obj.paginator.count }})</strong></h2>
                                </div>
                                <div class="card-body collapse show">
                                    <div class="row">
                                        <div class="col-md-2 " hidden>
                                            {% include 'genericfilters/filter_list_constancia.html' %}
                                        </div>
                                        <div class="col-md-12">
                                            {% trans "Buscar por Apellidos y Nombres o DNI" as placeholder %}
                                            {% include 'genericfilters/query_filter_constancia.html' %}

                                            <div class="table-responsive">
                                                <table class="table table-striped table-bordered ">
                                                    <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Constancia</th>
                                                        <th>Plaza</th>
                                                        <th>DNI</th>
                                                        <th>Apellidos y Nombres</th>
                                                        <th>Cargo</th>
                                                        <th>Fecha de Nacimiento</th>
                                                        <th>GÃ©nero</th>
                                                        <th>OPC</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for object in object_list %}
                                                        <tr>
                                                            <th>{{ forloop.counter0|add:page_obj.start_index }}</th>
                                                            <td class="text-center">
                                                                <span class="badge bg-secondary">{{ object.anio }}</span>
                                                            </td>
                                                            <td> <u>{{ object.plaza }}</u></td>
                                                            <td>{{ object.trabajador.dni }}</td>
                                                            <td>{{ object.trabajador.get_full_name_two }}</td>
                                                            <td>
                                                                {% get_cargo request.session.anio_bd object.trabajador object.anio.id %}
                                                            </td>
                                                            <td>{{ object.trabajador.fecha_nacimiento }}</td>
                                                            <td>
                                                                {% if object.trabajador.sexo == 'F' %}
                                                                    Femenino
                                                                {% else %}
                                                                    Masculino
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-success btn-sm"
                                                                        data-trabajador={{ object.trabajador.id }}
                                                                                data-pk={{ object.id }}
                                                                        data-anio={{ object.anio.id }}
                                                                                data-toggle="modal"
                                                                        data-target="#generar-constancia">
                                                                    <i class="la la-eye"></i>
                                                                    Ver
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            {% paginator %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>



    <div class="modal fade" id="generar-constancia" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Constancia</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div id="spinner-constancia">
                    <div class="loader">Cargando...</div>
                </div>

                <div id="content-constancia">

                </div>

            </div>
        </div>
    </div>

{% endblock container %}

{% block static %}

    <script type="application/javascript">

        $("#spinner-constancia").hide();

        function generarConstancia(trabajador_id, anio_id, pk) {

            console.log(" PK ");

            console.log(pk);

            $("#content-constancia").hide();
            $("#spinner-constancia").show();

            $.ajax({
                url: "{% url 'constancia:generar' %}",
                data: {
                    'trabajador_id': trabajador_id,
                    'anio_id': anio_id,
                    'pk': pk,
                },
                success: function (data) {
                    $("#spinner-constancia").hide();
                    $("#content-constancia").show();
                    $("#content-constancia").html(data);
                }
            });
        }


        $('#generar-constancia').on('show.bs.modal', function (e) {

            //get data-id attribute of the clicked element
            var trabajador_id = $(e.relatedTarget).data('trabajador');
            var anio_id = $(e.relatedTarget).data('anio');
            var pk = $(e.relatedTarget).data('pk');

            generarConstancia(trabajador_id, anio_id, pk);

            //populate the textbox
            {#$(e.currentTarget).find('input[name="bookId"]').val(bookId);#}
        });

    </script>


{% endblock static %}
